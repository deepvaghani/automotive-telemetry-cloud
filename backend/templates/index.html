<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Vehicle Digital Instrument Cluster</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body {
    margin: 0;
    background: radial-gradient(circle at center, #1a1a1a 0%, #000 70%);
    font-family: Orbitron, Arial, sans-serif;
    color: #eaeaea;
    overflow: hidden;
}

.cluster {
    display: grid;
    grid-template-columns: 1fr 1fr;
    height: 100vh;
}

.instruments {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 70px;
    background: linear-gradient(180deg, #050505, #111);
}

.speedometer {
    position: relative;
    width: 300px;
    height: 300px;
    border-radius: 50%;
    background: radial-gradient(circle, #111 40%, #000 70%);
    border: 6px solid rgba(0, 255, 255, 0.25);
}

.needle {
    position: absolute;
    width: 4px;
    height: 130px;
    background: red;
    top: 50%;
    left: 50%;
    transform-origin: bottom center;
    transform: rotate(-130deg);
}

.speed-text {
    position: absolute;
    bottom: 50px;
    width: 100%;
    text-align: center;
}

.speed-value {
    font-size: 56px;
}

.rpm-bar {
    height: 260px;
    width: 28px;
    background: #111;
    border-radius: 20px;
    overflow: hidden;
}

.rpm-fill {
    position: absolute;
    bottom: 0;
    width: 100%;
    height: 0%;
    background: linear-gradient(to top, #00ff88, #ffee00, #ff4444);
    transition: height 0.3s ease;
}

.temp-value {
    font-size: 36px;
    color: #ff7676;
}

#map {
    height: 100%;
}
</style>
</head>

<body>

<div class="cluster">

<div class="instruments">

<div>
<div>RPM</div>
<div class="rpm-bar">
<div class="rpm-fill" id="rpmFill"></div>
</div>
</div>

<div class="speedometer">
<div class="needle" id="needle"></div>
<div class="speed-text">
<div class="speed-value" id="speed">0</div>
<div>km/h</div>
</div>
</div>

<div>
<div class="temp-value" id="temp">-- °C</div>
<div>ENGINE TEMP</div>
</div>

</div>

<div id="map"></div>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
let map = L.map('map').setView([50.8321, 12.9214], 15);
let marker = L.marker([50.8321, 12.9214]).addTo(map);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
}).addTo(map);

async function updateDashboard() {
    try {
        const res = await fetch(`/telemetry?ts=${Date.now()}`, { cache: "no-store" });
        const data = await res.json();

        console.log("Telemetry:", data);

        if (!data.speed) return;

        // SPEED
        document.getElementById("speed").innerText = Math.round(data.speed);
        const angle = -130 + (data.speed / 140) * 260;
        document.getElementById("needle").style.transform = `rotate(${angle}deg)`;

        // RPM
        document.getElementById("rpmFill").style.height =
            Math.min((data.rpm / 6000) * 100, 100) + "%";

        // TEMP
        document.getElementById("temp").innerText =
            Math.round(data.engine_temp) + " °C";

        // GPS
        marker.setLatLng([data.lat, data.lon]);
        map.panTo([data.lat, data.lon], { animate: true });

    } catch (e) {
        console.log("Waiting for telemetry...");
    }
}

setInterval(updateDashboard, 1000);
updateDashboard();
</script>

</body>
</html>